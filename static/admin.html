<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G&A Rules Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/fold/brace-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/fold/foldgutter.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
<style>
:root{--bg:#0c0f14;--surface:#151921;--surface2:#1c2231;--surface3:#242c3d;--border:#2d3548;--border2:#3d4760;--text:#e0e4ec;--dim:#7a849b;--teal:#0ea5e9;--teal2:#06b6d4;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#8b5cf6;--white:#fff;--font:'S√∂hne',ui-sans-serif,-apple-system,sans-serif;--mono:'S√∂hne Mono','Fira Code',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}

/* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar .logo{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.sidebar .logo h1{font-size:15px;font-weight:600}
.sidebar .logo .badge{background:var(--teal);color:var(--white);font-size:9px;padding:2px 7px;border-radius:8px;font-weight:700;letter-spacing:.5px}
.sidebar nav{flex:1;padding:12px 0}
.sidebar nav button{width:100%;padding:10px 20px;background:none;border:none;color:var(--dim);font:14px var(--font);text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;transition:.15s}
.sidebar nav button:hover{color:var(--text);background:var(--surface2)}
.sidebar nav button.active{color:var(--teal);background:rgba(14,165,233,.08);border-right:2px solid var(--teal)}
.sidebar nav button .icon{width:18px;text-align:center;font-size:14px}
.sidebar .bb-status{padding:16px 20px;border-top:1px solid var(--border);font-size:11px;color:var(--dim)}
.sidebar .bb-status .dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:5px}

/* ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:var(--surface)}
.topbar h2{font-size:17px;font-weight:600;flex:1}
.topbar .btn{padding:7px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font:13px var(--font);cursor:pointer;display:flex;align-items:center;gap:6px;transition:.15s}
.topbar .btn:hover{border-color:var(--teal);color:var(--teal)}
.topbar .btn.primary{background:var(--teal);border-color:var(--teal);color:var(--white)}
.topbar .btn.primary:hover{opacity:.9}
.topbar .btn.danger{border-color:var(--red);color:var(--red)}

.content{flex:1;overflow-y:auto;padding:24px}
.panel{display:none}
.panel.active{display:block}

/* ‚îÄ‚îÄ‚îÄ Cards / Tables ‚îÄ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.card-body{padding:18px}

.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:10px 14px;color:var(--dim);font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);font-weight:500}
.tbl td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(14,165,233,.03)}
.tbl .id{font-family:var(--mono);font-size:12px;color:var(--teal)}
.tbl .tags{display:flex;gap:4px;flex-wrap:wrap}
.tbl .tag{background:var(--surface2);color:var(--dim);padding:2px 8px;border-radius:6px;font-size:10px}
.tbl .pri{font-family:var(--mono);font-size:12px;text-align:center}
.tbl .actions{display:flex;gap:6px}
.tbl .actions button{padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--dim);font:11px var(--font);cursor:pointer;transition:.15s}
.tbl .actions button:hover{color:var(--teal);border-color:var(--teal)}
.tbl .active-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.tbl .active-dot.on{background:var(--green)}
.tbl .active-dot.off{background:var(--red)}

/* ‚îÄ‚îÄ‚îÄ Toggle Switch ‚îÄ‚îÄ‚îÄ */
.toggle{position:relative;width:36px;height:20px;cursor:pointer}
.toggle input{display:none}
.toggle .slider{position:absolute;inset:0;background:var(--surface3);border-radius:20px;transition:.2s}
.toggle .slider::before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:var(--dim);left:2px;top:2px;transition:.2s}
.toggle input:checked+.slider{background:var(--teal)}
.toggle input:checked+.slider::before{transform:translateX(16px);background:var(--white)}

/* ‚îÄ‚îÄ‚îÄ Editor ‚îÄ‚îÄ‚îÄ */
.editor-container{display:flex;gap:0;height:calc(100vh - 140px);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.editor-pane{flex:1;display:flex;flex-direction:column;min-width:0}
.editor-pane .pane-header{padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:12px;color:var(--dim);font-weight:500;display:flex;align-items:center;gap:8px}
.editor-pane .pane-header .filename{color:var(--teal);font-family:var(--mono)}
.editor-pane .CodeMirror{flex:1;height:auto!important;font-family:var(--mono)!important;font-size:13px!important}
.preview-pane{flex:1;overflow-y:auto;padding:20px 24px;background:var(--surface);border-left:1px solid var(--border)}
.preview-pane h1,.preview-pane h2,.preview-pane h3{color:var(--text);margin:16px 0 8px}
.preview-pane p{color:var(--dim);margin:6px 0;line-height:1.7}
.preview-pane strong{color:var(--teal)}
.preview-pane table{border-collapse:collapse;margin:10px 0}
.preview-pane th,.preview-pane td{border:1px solid var(--border);padding:6px 12px;font-size:13px}

/* ‚îÄ‚îÄ‚îÄ Commit Modal ‚îÄ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;justify-content:center;align-items:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:480px;max-width:90vw;overflow:hidden;animation:slideUp .2s ease}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--border);font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:space-between}
.modal-header .close{background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer;padding:4px 8px}
.modal-body{padding:22px}
.modal-body label{display:block;font-size:12px;color:var(--dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.modal-body input,.modal-body textarea{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font:14px var(--font);outline:none;margin-bottom:16px;resize:none}
.modal-body input:focus,.modal-body textarea:focus{border-color:var(--teal)}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.modal-footer .btn{padding:8px 20px;border-radius:8px;font:13px var(--font);cursor:pointer;border:1px solid var(--border)}
.modal-footer .btn.cancel{background:var(--surface2);color:var(--dim)}
.modal-footer .btn.commit{background:var(--teal);border-color:var(--teal);color:var(--white)}

/* ‚îÄ‚îÄ‚îÄ Toasts ‚îÄ‚îÄ‚îÄ */
.toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:10px;font-size:13px;animation:slideIn .3s ease;display:flex;align-items:center;gap:8px;min-width:280px}
.toast.success{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);color:var(--green)}
.toast.error{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:var(--red)}
.toast.info{background:rgba(14,165,233,.15);border:1px solid rgba(14,165,233,.3);color:var(--teal)}

/* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;text-align:center}
.stat .val{font-size:30px;font-weight:700;font-family:var(--mono)}
.stat .lbl{font-size:11px;color:var(--dim);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.stat.teal .val{color:var(--teal)}
.stat.green .val{color:var(--green)}
.stat.purple .val{color:var(--purple)}
.stat.orange .val{color:var(--orange)}

/* ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ */
.search{padding:8px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font:13px var(--font);width:250px;outline:none}
.search:focus{border-color:var(--teal)}

@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:none}}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="logo">
    <h1>G&A Admin</h1>
    <span class="badge">POC</span>
  </div>
  <nav>
    <button class="active" onclick="showPanel('dashboard',this)"><span class="icon">üìä</span> Dashboard</button>
    <button onclick="showPanel('rules',this)"><span class="icon">‚öôÔ∏è</span> Rules</button>
    <button onclick="showPanel('messages',this)"><span class="icon">üìù</span> Messages</button>
    <button onclick="showPanel('history',this)"><span class="icon">üìú</span> History</button>
    <button onclick="location.href='/'"><span class="icon">üí¨</span> Chat UI</button>
  </nav>
  <div class="bb-status" id="bbStatus">Checking Bitbucket...</div>
</div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <h2 id="pageTitle">Dashboard</h2>
    <button class="btn" onclick="syncFromBB()">üîÑ Sync from Bitbucket</button>
    <button class="btn" onclick="reloadEngine()">‚ö° Hot Reload</button>
  </div>
  <div class="content">

    <!-- DASHBOARD -->
    <div class="panel active" id="panel-dashboard">
      <div class="stats" id="dashStats"></div>
      <div class="card">
        <div class="card-header">Quick Actions</div>
        <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn primary" onclick="showPanel('rules',document.querySelector('nav button:nth-child(2)'))">Edit Rules</button>
          <button class="btn primary" onclick="showPanel('messages',document.querySelector('nav button:nth-child(3)'))">Edit Messages</button>
          <button class="btn" onclick="syncFromBB()">Pull from Bitbucket</button>
          <button class="btn" onclick="reloadEngine()">Reload Engine</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Recent Commits</div>
        <div class="card-body" id="dashHistory">Loading...</div>
      </div>
    </div>

    <!-- RULES -->
    <div class="panel" id="panel-rules">
      <div id="rules-list-view">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <input class="search" placeholder="Search rules..." oninput="filterRules(this.value)">
        </div>
        <div class="card">
          <table class="tbl" id="rulesTable"><thead><tr>
            <th>Status</th><th>Rule ID</th><th>Name</th><th>Priority</th><th>Tags</th><th>Message</th><th>Actions</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="rules-edit-view" style="display:none">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <button class="btn" onclick="closeRuleEditor()">‚Üê Back to Rules</button>
          <span style="flex:1;font-size:14px;color:var(--dim)" id="editingRuleLabel"></span>
          <button class="btn" onclick="validateCurrentRule()">‚úì Validate</button>
          <button class="btn primary" onclick="openCommitModal('rule')">üíæ Save & Commit</button>
        </div>
        <div class="editor-container">
          <div class="editor-pane">
            <div class="pane-header">üìÑ <span class="filename" id="ruleEditorFilename">rule.json</span></div>
            <textarea id="ruleEditorTA"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- MESSAGES -->
    <div class="panel" id="panel-messages">
      <div id="msg-list-view">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <input class="search" placeholder="Search messages..." oninput="filterMessages(this.value)">
          <button class="btn primary" onclick="openNewMessageModal()" style="margin-left:auto">+ New Message</button>
        </div>
        <div class="card">
          <table class="tbl" id="msgTable"><thead><tr>
            <th>Template</th><th>Preview</th><th>Placeholders</th><th>Size</th><th>Actions</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="msg-edit-view" style="display:none">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <button class="btn" onclick="closeMsgEditor()">‚Üê Back to Messages</button>
          <span style="flex:1;font-size:14px;color:var(--dim)" id="editingMsgLabel"></span>
          <button class="btn primary" onclick="openCommitModal('message')">üíæ Save & Commit</button>
        </div>
        <div class="editor-container">
          <div class="editor-pane">
            <div class="pane-header">üìÑ <span class="filename" id="msgEditorFilename">message.md</span></div>
            <textarea id="msgEditorTA"></textarea>
          </div>
          <div class="preview-pane" id="msgPreview"><p style="color:var(--dim)">Preview will appear here...</p></div>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="panel" id="panel-history">
      <div class="card">
        <div class="card-header">Commit History (Bitbucket)</div>
        <div class="card-body" id="historyBody">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Commit Modal -->
<div class="modal-overlay" id="commitModal">
  <div class="modal">
    <div class="modal-header">
      <span>Commit to Bitbucket</span>
      <button class="close" onclick="closeCommitModal()">&times;</button>
    </div>
    <div class="modal-body">
      <label>Commit Message</label>
      <input id="commitMsg" placeholder="Describe what changed..." autofocus>
      <label>Author</label>
      <input id="commitAuthor" value="G&A Admin">
    </div>
    <div class="modal-footer">
      <button class="btn cancel" onclick="closeCommitModal()">Cancel</button>
      <button class="btn commit" onclick="executeCommit()">Commit & Push</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toasts"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rulesData = [];
let messagesData = [];
let ruleEditor = null;
let msgEditor = null;
let currentEditingRule = null;
let currentEditingMsg = null;
let commitTarget = null; // 'rule' or 'message'

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  if (btn) btn.classList.add('active');
  const titles = { dashboard:'Dashboard', rules:'Rules Editor', messages:'Message Templates', history:'Commit History' };
  document.getElementById('pageTitle').textContent = titles[id] || id;
  if (id === 'rules') loadRules();
  if (id === 'messages') loadMessages();
  if (id === 'history') loadHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type='info') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `${type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ'} ${msg}`;
  document.getElementById('toasts').appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDashboard() {
  try {
    const [cfg, health, hist] = await Promise.all([
      fetch('/admin/api/config').then(r=>r.json()),
      fetch('/api/health').then(r=>r.json()),
      fetch('/admin/api/history?limit=5').then(r=>r.json()),
    ]);

    // Stats
    document.getElementById('dashStats').innerHTML = `
      <div class="stat teal"><div class="val">${health.rules_loaded}</div><div class="lbl">Active Rules</div></div>
      <div class="stat green"><div class="val">${health.messages_loaded}</div><div class="lbl">Message Templates</div></div>
      <div class="stat purple"><div class="val">${health.openai_configured ? 'ON' : 'OFF'}</div><div class="lbl">OpenAI</div></div>
      <div class="stat orange"><div class="val">${cfg.bitbucket.configured ? 'ON' : 'OFF'}</div><div class="lbl">Bitbucket</div></div>
    `;

    // Bitbucket status
    const s = document.getElementById('bbStatus');
    if (cfg.bitbucket.configured) {
      s.innerHTML = `<span class="dot" style="background:var(--green)"></span> ${cfg.bitbucket.workspace}/${cfg.bitbucket.repo}<br><small style="color:var(--dim)">Branch: ${cfg.bitbucket.branch}</small>`;
    } else {
      s.innerHTML = `<span class="dot" style="background:var(--orange)"></span> Local mode<br><small style="color:var(--dim)">Configure .env for Bitbucket</small>`;
    }

    // History
    if (hist.commits && hist.commits.length) {
      document.getElementById('dashHistory').innerHTML = hist.commits.map(c => `
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)">
          <code style="color:var(--teal);font-size:12px">${c.hash}</code>
          <span style="flex:1;font-size:13px">${c.message}</span>
          <span style="font-size:11px;color:var(--dim)">${c.date ? new Date(c.date).toLocaleDateString() : ''}</span>
        </div>
      `).join('');
    } else {
      document.getElementById('dashHistory').innerHTML = '<p style="color:var(--dim);font-size:13px">No commits found. Configure Bitbucket to see history.</p>';
    }
  } catch(e) {
    console.error(e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RULES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadRules() {
  const data = await fetch('/admin/api/rules').then(r=>r.json());
  rulesData = data.rules || [];
  renderRulesTable(rulesData);
}

function renderRulesTable(rules) {
  const tbody = document.querySelector('#rulesTable tbody');
  tbody.innerHTML = rules.map(r => `
    <tr>
      <td><span class="active-dot ${r.active?'on':'off'}"></span></td>
      <td class="id">${r.id}</td>
      <td>${r.name}</td>
      <td class="pri">${r.priority}</td>
      <td><div class="tags">${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div></td>
      <td><code style="font-size:11px;color:var(--dim)">${r.message_ref}</code></td>
      <td class="actions">
        <button onclick="editRule('${r.id}')">Edit</button>
        <button onclick="toggleRule('${r.id}',${!r.active})">${r.active?'Disable':'Enable'}</button>
      </td>
    </tr>
  `).join('');
}

function filterRules(q) {
  const f = rulesData.filter(r => JSON.stringify(r).toLowerCase().includes(q.toLowerCase()));
  renderRulesTable(f);
}

async function editRule(ruleId) {
  const rule = await fetch(`/admin/api/rules/${ruleId}`).then(r=>r.json());
  currentEditingRule = ruleId;

  document.getElementById('rules-list-view').style.display = 'none';
  document.getElementById('rules-edit-view').style.display = 'block';
  document.getElementById('editingRuleLabel').textContent = `Editing: ${ruleId}`;
  document.getElementById('ruleEditorFilename').textContent = `${ruleId} (in ga_rules.json)`;

  if (ruleEditor) ruleEditor.toTextArea();
  document.getElementById('ruleEditorTA').value = JSON.stringify(rule, null, 2);

  ruleEditor = CodeMirror.fromTextArea(document.getElementById('ruleEditorTA'), {
    mode: 'application/json',
    theme: 'dracula',
    lineNumbers: true,
    matchBrackets: true,
    autoCloseBrackets: true,
    foldGutter: true,
    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
    tabSize: 2,
    indentWithTabs: false,
  });
  ruleEditor.setSize('100%', '100%');
}

function closeRuleEditor() {
  document.getElementById('rules-list-view').style.display = 'block';
  document.getElementById('rules-edit-view').style.display = 'none';
  currentEditingRule = null;
}

async function validateCurrentRule() {
  try {
    const json = JSON.parse(ruleEditor.getValue());
    toast('JSON is valid ‚úì', 'success');
  } catch(e) {
    toast(`Invalid JSON: ${e.message}`, 'error');
  }
}

async function toggleRule(ruleId, active) {
  const msg = `${active?'Activate':'Deactivate'} rule ${ruleId}`;
  const res = await fetch(`/admin/api/rules/${ruleId}/toggle`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active, commit_message: msg })
  }).then(r=>r.json());
  toast(res.message || msg, res.success?'success':'error');
  loadRules();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadMessages() {
  const data = await fetch('/admin/api/messages').then(r=>r.json());
  messagesData = data.messages || [];
  renderMessagesTable(messagesData);
}

function renderMessagesTable(msgs) {
  const tbody = document.querySelector('#msgTable tbody');
  tbody.innerHTML = msgs.map(m => `
    <tr>
      <td class="id">${m.name}</td>
      <td style="font-size:12px;color:var(--dim);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.preview}</td>
      <td><div class="tags">${(m.placeholders||[]).map(p=>`<span class="tag">${p}</span>`).join('')||'<span style="color:var(--dim)">none</span>'}</div></td>
      <td style="font-size:12px;color:var(--dim)">${m.length} chars</td>
      <td class="actions"><button onclick="editMessage('${m.name}')">Edit</button></td>
    </tr>
  `).join('');
}

function filterMessages(q) {
  const f = messagesData.filter(m => JSON.stringify(m).toLowerCase().includes(q.toLowerCase()));
  renderMessagesTable(f);
}

async function editMessage(name) {
  const msg = await fetch(`/admin/api/messages/${name}`).then(r=>r.json());
  currentEditingMsg = name;

  document.getElementById('msg-list-view').style.display = 'none';
  document.getElementById('msg-edit-view').style.display = 'block';
  document.getElementById('editingMsgLabel').textContent = `Editing: ${name}.md`;
  document.getElementById('msgEditorFilename').textContent = `${name}.md`;

  if (msgEditor) msgEditor.toTextArea();
  document.getElementById('msgEditorTA').value = msg.raw_content || msg.body || '';

  msgEditor = CodeMirror.fromTextArea(document.getElementById('msgEditorTA'), {
    mode: 'markdown',
    theme: 'dracula',
    lineNumbers: true,
    lineWrapping: true,
    tabSize: 2,
  });
  msgEditor.setSize('100%', '100%');
  msgEditor.on('change', () => updateMsgPreview());
  updateMsgPreview();
}

function updateMsgPreview() {
  if (!msgEditor) return;
  let content = msgEditor.getValue();
  // Strip frontmatter
  const parts = content.split('---');
  if (parts.length >= 3) content = parts.slice(2).join('---');
  // Highlight placeholders
  content = content.replace(/\{\{(.+?)\}\}/g, '<code style="background:rgba(14,165,233,.15);color:var(--teal);padding:1px 4px;border-radius:3px">{{$1}}</code>');
  document.getElementById('msgPreview').innerHTML = marked.parse(content);
}

function closeMsgEditor() {
  document.getElementById('msg-list-view').style.display = 'block';
  document.getElementById('msg-edit-view').style.display = 'none';
  currentEditingMsg = null;
}

function openNewMessageModal() {
  const name = prompt('Enter message template name (uppercase, e.g. MY_NEW_MESSAGE):');
  if (!name) return;
  if (!/^[A-Z0-9_]+$/.test(name)) { toast('Name must be UPPERCASE with underscores only','error'); return; }
  const template = `---\nrule_id: NEW_RULE\nplaceholders: []\n---\n\nEnter your message here.\n`;
  currentEditingMsg = name;
  document.getElementById('msg-list-view').style.display = 'none';
  document.getElementById('msg-edit-view').style.display = 'block';
  document.getElementById('editingMsgLabel').textContent = `Creating: ${name}.md`;
  document.getElementById('msgEditorFilename').textContent = `${name}.md (new)`;
  if (msgEditor) msgEditor.toTextArea();
  document.getElementById('msgEditorTA').value = template;
  msgEditor = CodeMirror.fromTextArea(document.getElementById('msgEditorTA'), {
    mode:'markdown', theme:'dracula', lineNumbers:true, lineWrapping:true, tabSize:2
  });
  msgEditor.setSize('100%','100%');
  msgEditor.on('change', () => updateMsgPreview());
  updateMsgPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadHistory() {
  const data = await fetch('/admin/api/history?limit=30').then(r=>r.json());
  const body = document.getElementById('historyBody');
  if (!data.commits || !data.commits.length) {
    body.innerHTML = '<p style="color:var(--dim)">No history available. Configure Bitbucket in .env.</p>';
    return;
  }
  body.innerHTML = `<table class="tbl"><thead><tr><th>Hash</th><th>Message</th><th>Author</th><th>Date</th></tr></thead><tbody>
    ${data.commits.map(c => `<tr>
      <td><code style="color:var(--teal)">${c.hash}</code></td>
      <td>${c.message}</td>
      <td style="color:var(--dim)">${c.author}</td>
      <td style="color:var(--dim);font-size:12px">${c.date ? new Date(c.date).toLocaleString() : ''}</td>
    </tr>`).join('')}
  </tbody></table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMIT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCommitModal(target) {
  commitTarget = target;
  const name = target === 'rule' ? currentEditingRule : currentEditingMsg;
  document.getElementById('commitMsg').value = `Update ${target}: ${name}`;
  document.getElementById('commitModal').classList.add('show');
  document.getElementById('commitMsg').focus();
}

function closeCommitModal() {
  document.getElementById('commitModal').classList.remove('show');
}

async function executeCommit() {
  const msg = document.getElementById('commitMsg').value.trim();
  const author = document.getElementById('commitAuthor').value.trim();
  if (!msg) { toast('Commit message required','error'); return; }

  closeCommitModal();

  try {
    if (commitTarget === 'rule' && currentEditingRule) {
      const ruleJson = JSON.parse(ruleEditor.getValue());
      const res = await fetch(`/admin/api/rules/${currentEditingRule}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ rule_json: ruleJson, commit_message: msg, author })
      }).then(r=>r.json());
      if (res.success) {
        toast(`Committed: ${msg}`, 'success');
        closeRuleEditor();
        loadRules();
      } else {
        toast(res.detail || res.message || 'Commit failed', 'error');
      }
    } else if (commitTarget === 'message' && currentEditingMsg) {
      const content = msgEditor.getValue();
      const res = await fetch(`/admin/api/messages/${currentEditingMsg}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ content, commit_message: msg, author })
      }).then(r=>r.json());
      if (res.success) {
        toast(`Committed: ${msg}`, 'success');
        closeMsgEditor();
        loadMessages();
      } else {
        toast(res.detail || res.message || 'Commit failed', 'error');
      }
    }
  } catch(e) {
    toast(`Error: ${e.message}`, 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncFromBB() {
  toast('Syncing from Bitbucket...', 'info');
  const res = await fetch('/admin/api/sync-from-bb', {method:'POST'}).then(r=>r.json());
  toast(res.message, res.success ? 'success' : 'error');
  loadDashboard();
}

async function reloadEngine() {
  const res = await fetch('/api/reload', {method:'POST'}).then(r=>r.json());
  toast(`Reloaded: ${res.rules_count} rules, ${res.messages_count} messages`, 'success');
  loadDashboard();
}

// ‚îÄ‚îÄ‚îÄ Keyboard shortcut ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (currentEditingRule) openCommitModal('rule');
    else if (currentEditingMsg) openCommitModal('message');
  }
  if (e.key === 'Escape') closeCommitModal();
});

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
loadDashboard();
</script>
</body>
</html>
